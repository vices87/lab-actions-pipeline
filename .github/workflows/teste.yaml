name: Python CI/CD Pipeline

# Este workflow é disparado manualmente (workflow_dispatch) ou pode ser ativado por push/pull_request
on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    # Permite rodar passos em paralelo, se necessário

    steps:
      # --------------------------------------------------------
      # 1️⃣ Checkout do código
      # Pega todo o repositório e deixa disponível para o runner
      # --------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v6

      # --------------------------------------------------------
      # 2️⃣ Setup do Python
      # Configura o Python na versão desejada
      # --------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------------------------
      # 3️⃣ Instalar dependências
      # Atualiza pip, instala requirements e ferramentas de análise
      # --------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Ferramentas de lint, formatação, testes e segurança
          pip install pylint pytest pytest-cov black isort bandit safety

      # --------------------------------------------------------
      # 4️⃣ Linting / Análise de Código
      # Pylint verifica erros de estilo, convenções e qualidade
      # black / isort garante formatação consistente
      # --------------------------------------------------------
      - name: Lint code
        run: |
          # pylint nos arquivos Python
          # Ignoramos mensagens de docstring e classes pequenas para não quebrar o CI
          pylint main.py app --fail-under=8.0 --disable=C0114,C0115,C0116,R0903

          # Verifica formatação com black
          black --check main.py app

          # Verifica organização de imports com isort
          isort --check-only main.py app

      # --------------------------------------------------------
      # 5️⃣ Static Analysis / Segurança
      # Bandit: vulnerabilidades de código Python
      # Safety: dependências inseguras
      # --------------------------------------------------------
      - name: Security scan
        run: |
          bandit -r app main.py
          safety check

      # --------------------------------------------------------
      # 6️⃣ Unit Tests
      # Rodar testes automatizados
      # Coverage report para garantir cobertura de código
      # --------------------------------------------------------
      - name: Run unit tests
        run: |
          # Rodando pytest na raiz e dentro de app
          # Se não houver testes, pytest retorna exit code 5
          pytest main.py app --cov=app --cov-report=term-missing

      # --------------------------------------------------------
      # 7️⃣ (Opcional) Integration / E2E / Smoke Tests
      # Podem ser adicionados quando houver testes reais de integração
      # --------------------------------------------------------
      # - name: Run integration tests
      #   run: |
      #     pytest integration_tests/ --cov=app --cov-report=term-missing

      # --------------------------------------------------------
      # 8️⃣ Build Docker Image (opcional)
      # Só builda se todos os passos anteriores passarem
      # --------------------------------------------------------
      # - name: Build Docker image
      #   run: |
      #     docker build -t myapp:${GITHUB_SHA} .

      # --------------------------------------------------------
      # 9️⃣ Push Docker / Deploy (opcional)
      # Tags e push para registry ou deploy automático
      # --------------------------------------------------------
      # - name: Push Docker image
      #   run: |
      #     docker tag myapp:${GITHUB_SHA} registry.company.com/myapp:${GITHUB_SHA}
      #     docker push registry.company.com/myapp:${GITHUB_SHA}

      # --------------------------------------------------------
      # 10️⃣ Notificações (Slack / Teams / Email)
      # Pode ser adicionado para avisar equipe sobre falhas ou sucesso
      # --------------------------------------------------------
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     channel-id: ${{ secrets.SLACK_CHANNEL }}
      #     slack-token: ${{ secrets.SLACK_TOKEN }}
