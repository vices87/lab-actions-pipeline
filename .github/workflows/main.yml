# Nome do workflow 
name: Deploy to EKS

# Define o trigger (push na main)
on:
  push:
    branches:
      - main   

# Permissões necessárias para OIDC (autenticação sem secrets)
permissions:
  id-token: write   # permite emitir token OIDC para a AWS
  contents: read    # permite ler o código do repositório

env:
  AWS_REGION: us-east-1                 
  EKS_CLUSTER_NAME: my-eks-cluster      
  ECR_REPOSITORY: my-app                
  IMAGE_TAG: ${{ github.sha }}          # Tag da imagem (commit SHA)

jobs:
  deploy:
    # Runner usado pelo GitHub Actions
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1️⃣ Clona o repositório
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        # Sem isso, o runner não tem acesso ao código

      # -------------------------------------------------
      # 2️⃣ Autenticação na AWS usando OIDC (best practice)
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-actions-eks
          aws-region: ${{ env.AWS_REGION }}
        # Assume uma IAM Role na AWS sem usar access keys fixas
        # Mais seguro e recomendado pela AWS

      # --------------------------------
      # 3️⃣ Login no Amazon ECR
      # --------------------------------
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        # Necessário para fazer docker push no ECR

      # ----------------------------------------
      # 4️⃣ Build e Push da imagem Docker
      # ----------------------------------------
      - name: Build and push Docker image
        run: |
          # Build da imagem localmente
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

          # Tag da imagem no formato esperado pelo ECR
          docker tag $ECR_REPOSITORY:$IMAGE_TAG \
            123456789012.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

          # Push da imagem para o ECR
          docker push \
            123456789012.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

      # ---------------------------------------
      # 5️⃣ Atualiza o kubeconfig do EKS
      # ---------------------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER_NAME
        # Cria um kubeconfig temporário no runner
        # Permite que kubectl/helm se conectem ao cluster

      # --------------------------------
      # 6️⃣ Deploy no Kubernetes (EKS)
      # --------------------------------
      - name: Deploy to EKS
        run: |
          kubectl set image deployment/my-app \
            my-app=123456789012.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
        # Atualiza a imagem do deployment
        # O Kubernetes faz rolling update automaticamente
