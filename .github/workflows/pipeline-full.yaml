name: Full ci/cd pipeline

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  # --------------------------------------------------------
  # 1️⃣ Lint & Formatting
  # Verifica qualidade do código e formatação
  # --------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install lint tools and dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint 

      - name: Run lint and format checks
        run: |
          pylint main.py app --fail-under=5.0 

  # --------------------------------------------------------
  # 2️⃣ Security Scan
  # Bandit e Safety para vulnerabilidades de código e dependências
  # --------------------------------------------------------
  # security:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Install security tools
  #       run: |
  #         pip install bandit safety

  #     - name: Run security scan
  #       run: |
  #         bandit -r app main.py
  #         safety check

  # --------------------------------------------------------
  # 3️⃣ Unit Tests + Coverage
  # Pytest para validar funcionalidades e gerar cobertura
  # --------------------------------------------------------
  # tests:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Install test dependencies
  #       run: |
  #         pip install -r requirements.txt pytest pytest-cov

  #     - name: Run tests and coverage
  #       run: |
  #         pytest main.py app --cov=app --cov-report=term-missing

  # --------------------------------------------------------
  # 4️⃣ Build Docker
  # Build da imagem, somente se lint, security e tests passarem
  # --------------------------------------------------------
  build-docker:
#    needs: [lint, security, tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build Docker image
        run: |
          docker build -t myapp:${GITHUB_SHA} .

  # --------------------------------------------------------
  # 5️⃣ Deploy
  # Executa apenas se todos os jobs anteriores passarem
  # Pode ser deploy em staging/prod
  # --------------------------------------------------------
  deploy-eks:
 #   needs: [build-docker]  # só roda se Docker build passar
    runs-on: ubuntu-latest
    steps:
      # --------------------------------------------------------
      # 1️⃣ Checkout do código
      # --------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v6

      # --------------------------------------------------------
      # 2️⃣ Configurar AWS CLI via OIDC
      # - role-to-assume: IAM Role criado no AWS que confia no GitHub OIDC
      # --------------------------------------------------------
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/github-actions-eks-role
          aws-region: us-east-1  

      # --------------------------------------------------------
      # 3️⃣ Instalar kubectl
      # --------------------------------------------------------
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # --------------------------------------------------------
      # 4️⃣ Atualizar kubeconfig do cluster EKS
      # --------------------------------------------------------
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name my-eks-cluster

      # --------------------------------------------------------
      # 5️⃣ Deploy da aplicação
      # - Usando manifests do Kubernetes (k8s/) ou Helm chart
      # --------------------------------------------------------
      - name: Deploy app
        run: |
          # Se estiver usando manifests:
          kubectl apply -f k8s/

          # Se estiver usando Helm:
          # helm upgrade --install myapp k8s/helm-chart --set image.tag=${GITHUB_SHA}

      # --------------------------------------------------------
      # 6️⃣ Verificar rollout (garante que o deploy subiu corretamente)
      # --------------------------------------------------------
      - name: Verify deployment rollout
        run: |
          kubectl rollout status deployment/myapp

      # --------------------------------------------------------
      # 7️⃣ Opcional: notificações
      # - Slack / Teams / Email
      # --------------------------------------------------------
      - name: Notify Slack (optional)
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL }}
          slack-token: ${{ secrets.SLACK_TOKEN }}
          text: "Deploy finished: ${{ github.workflow }} run ${{ github.run_number }} - Status: ${{ job.status }}"



